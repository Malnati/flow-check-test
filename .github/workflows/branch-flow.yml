name: branch-flow

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  flow-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. An√°lise (Gera o JSON com a Guidance inteligente)
      - name: Guard
        id: flow
        uses: Malnati/branch-flow-guard@v1.2.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output_file: "flow-compliance.json"

      # 2. Carregar Dados
      - name: Load Data
        id: data
        run: |
          {
            echo "json_content<<EOF"
            cat flow-compliance.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # 3. Postar Coment√°rio
      - name: Post Comment
        uses: Malnati/pr-comment@v6.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          template_path: .github/workflows/branch-flow.md
          message_id: "branch-flow-guard-status"
          
          header_title: "üõ°Ô∏è Branch Flow Guard"
          header_subject: "Validacao de Fluxo"
          header_actor: "github-actions[bot]"
          
          body_message: |
            <div align="center">
            
            | üö¶ Status | üõ´ Origem | üõ¨ Destino |
            | :---: | :---: | :---: |
            | **${{ fromJson(steps.data.outputs.json_content).ui.message_md }}** | `${{ fromJson(steps.data.outputs.json_content).context.head_branch }}` | `${{ fromJson(steps.data.outputs.json_content).context.base_branch }}` |
            
            </div>
          
          # MUDAN√áA 1: Usamos 'ui.guidance_md' que cont√©m a lista de branches permitidas
          footer_result: >-
             ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed && 
             format('‚õî Bloqueado (C√≥digo: {0})', fromJson(steps.data.outputs.json_content).compliance.violation_code) || 
             '‚úÖ Autorizado' }}
          
          footer_advise: ${{ fromJson(steps.data.outputs.json_content).ui.guidance_md }}

      # 4. Bloqueio Hard (Com Log Rico)
      - name: Block PR if Violation
        if: ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed }}
        run: |
          # MUDAN√áA 2: Pegamos a mensagem de orienta√ß√£o do JSON para exibir no log de erro
          GUIDANCE="${{ fromJson(steps.data.outputs.json_content).ui.guidance_md }}"
          
          # Removemos formata√ß√£o markdown (**) para ficar limpo no log do console
          CLEAN_GUIDANCE=$(echo "$GUIDANCE" | sed 's/\*\*//g' | sed 's/`//g')
          
          echo "::error title=Branch Flow Violation::$CLEAN_GUIDANCE"
          echo "::notice::Dica: Voc√™ pode ajustar as branches permitidas nos inputs do workflow."
          exit 1
