jobs:
  flow-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Roda a validaÃ§Ã£o e gera o arquivo
      - name: Guard
        id: flow
        uses: Malnati/branch-flow-guard@v1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output_file: "flow-compliance.json"

      # 2. LÃª o arquivo para Output (mesmo passo da conversa anterior)
      - name: Load Data
        id: data
        run: |
          {
            echo "json_content<<EOF"
            cat flow-compliance.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # 3. Postar ComentÃ¡rio
      - name: Post Comment
        uses: Malnati/pr-comment@v4.2.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          template_path: .github/templates/pr-comment-branch-flow.md
          
          # --- AQUI ESTÃ O TRUQUE ---
          # NÃ³s construÃ­mos o conteÃºdo rico usando funÃ§Ãµes do GitHub Actions (format)
          # e injetamos tudo dentro do input 'body_message'.
          
          header_title: "ğŸ›¡ï¸ Branch Flow Guard"
          header_subject: "Validacao de Fluxo"
          header_actor: "github-actions[bot]"
          
          body_message: |
            <div align="center">
            
            | ğŸš¦ Status | ğŸ›« Origem | ğŸ›¬ Destino |
            | :---: | :---: | :---: |
            | **${{ fromJson(steps.data.outputs.json_content).ui.message_md }}** | `${{ fromJson(steps.data.outputs.json_content).context.head_branch }}` | `${{ fromJson(steps.data.outputs.json_content).context.base_branch }}` |
            
            </div>
          
          # Mapeamos o cÃ³digo de violaÃ§Ã£o para o rodapÃ© se houver erro
          footer_result: >-
             ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed && 
             format('â›” Bloqueado (CÃ³digo: {0})', fromJson(steps.data.outputs.json_content).compliance.violation_code) || 
             'âœ… Autorizado' }}
          
          footer_advise: >-
             ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed && 
             'Feche esta PR e alinhe as branches corretamente.' || 
             'Pode prosseguir com o Code Review.' }}
