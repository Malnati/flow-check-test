# .github/workflows/branch-flow.yml
name: branch-flow

on:
  pull_request: {}

permissions:
  contents: read
  pull-requests: write
  issues: write # Necess√°rio para apagar coment√°rios antigos

jobs:
  flow-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # ----------------------------------------------------------------
      # 1. Roda a valida√ß√£o e gera o JSON
      # ----------------------------------------------------------------
      - name: Guard
        id: flow
        uses: Malnati/branch-flow-guard@v1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output_file: "flow-compliance.json"

      # ----------------------------------------------------------------
      # 2. L√™ o arquivo para Output (Carrega os dados)
      # ----------------------------------------------------------------
      - name: Load Data
        id: data
        run: |
          {
            echo "json_content<<EOF"
            cat flow-compliance.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------------
      # CORRE√á√ÉO 1: Limpar coment√°rios anteriores do Bot
      # Isso resolve o problema das mensagens duplicadas.
      # ----------------------------------------------------------------
      - name: Delete Previous Comments
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            
            // Busca coment√°rios existentes na PR
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number,
            });

            // Filtra coment√°rios que t√™m o T√≠tulo da nossa Action
            const botComments = comments.filter(c => 
              c.body.includes('üõ°Ô∏è Branch Flow Guard') && 
              c.user.type === 'Bot'
            );

            // Deleta os antigos
            for (const comment of botComments) {
              await github.rest.issues.deleteComment({
                owner, repo, comment_id: comment.id,
              });
            }

      # ----------------------------------------------------------------
      # 3. Postar Novo Coment√°rio 
      # ----------------------------------------------------------------
      - name: Post Comment
        uses: Malnati/pr-comment@v5.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.pull_request.number }}
          # IMPORTANTE: Verifique se este arquivo existe no seu repo!
          template_path: .github/workflows/pr-comment-branch-flow.md
          
          header_title: "üõ°Ô∏è Branch Flow Guard"
          header_subject: "Validacao de Fluxo"
          header_actor: "github-actions[bot]"
          
          # Monta a tabela HTML
          body_message: |
            <div align="center">
            
            | üö¶ Status | üõ´ Origem | üõ¨ Destino |
            | :---: | :---: | :---: |
            | **${{ fromJson(steps.data.outputs.json_content).ui.message_md }}** | `${{ fromJson(steps.data.outputs.json_content).context.head_branch }}` | `${{ fromJson(steps.data.outputs.json_content).context.base_branch }}` |
            
            </div>
          
          footer_result: >-
             ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed && 
             format('‚õî Bloqueado (C√≥digo: {0})', fromJson(steps.data.outputs.json_content).compliance.violation_code) || 
             '‚úÖ Autorizado' }}
          
          footer_advise: >-
             ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed && 
             'Feche esta PR e alinhe as branches corretamente.' || 
             'Pode prosseguir com o Code Review.' }}

      # ----------------------------------------------------------------
      # CORRE√á√ÉO 2: Bloquear a PR de verdade (Status Vermelho)
      # Se n√£o for permitido, for√ßa erro e impede o merge.
      # ----------------------------------------------------------------
      - name: Block PR if Violation
        if: ${{ !fromJson(steps.data.outputs.json_content).compliance.allowed }}
        run: |
          echo "::error title=Branch Flow Violation::O fluxo de branches est√° incorreto. Merge bloqueado."
          exit 1
